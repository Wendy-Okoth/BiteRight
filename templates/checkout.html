{% extends "base.html" %}
{% block content %}

<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-md-6">
      <div class="card shadow-lg border-0 rounded-3">
        <div class="card-header bg-primary text-white text-center">
          <h4>Checkout</h4>
        </div>
        <div class="card-body text-center">
          <p class="mb-4">
            Support <strong>BiteRight</strong> and unlock premium features üéâ
          </p>
          <p class="text-muted">
            Click the button below to proceed with a secure payment via Flutterwave.
          </p>

          <!-- Pay button (not inside a form) -->
          <button 
            type="button"
            id="payButton"
            class="btn btn-success btn-lg px-4">
            Pay Now
          </button>
        </div>
        <div class="card-footer text-center text-muted">
          Transactions are secured with SSL üîí
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Flutterwave Inline JS -->
<script src="https://checkout.flutterwave.com/v3.js"></script>
<script>
document.getElementById("payButton").addEventListener("click", function() {
    console.log("üöÄ makePayment() called");
    FlutterwaveCheckout({
        public_key: "{{ FLW_PUBLIC_KEY }}",  
        tx_ref: "biteright-" + Date.now(),
        amount: 500,
        currency: "KES",
        payment_options: "card, mobilemoney, ussd",
        customer: {
            email: "{{ session.get('email', 'user@example.com') }}",
            phone_number: "07100000000",
            name: "{{ session.get('username', 'BiteRight User') }}"
        },
        customizations: {
            title: "BiteRight Premium",
            description: "Access exclusive features and support us üíö",
            logo: "{{ url_for('static', filename='images/logo.png') }}"
        },
        callback: function (data) {
            console.log("‚úÖ Payment complete:", data);

            fetch("/verify-payment", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ transaction_id: data.transaction_id })
            })
            .then(res => res.json())
            .then(result => {
                if (result.status === "success") {
                    alert("‚úÖ Payment successful!");
                    window.location.href = "/";
                } else {
                    alert("‚ö†Ô∏è Payment verification failed.");
                }
            });
        },
        onclose: function() {
            console.log("‚ùå Payment popup closed");
        },
    });
});
</script>

{% endblock %}
