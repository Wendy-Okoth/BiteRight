{% extends "base.html" %}
{% block content %}

<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
      <div class="card shadow-lg border-0 rounded-3">
        <div class="card-header text-center" style="background:linear-gradient(90deg,#fff,#ffccd9);">
          <h4 style="color:#800040; margin:0;">BiteRight Premium</h4>
        </div>

        <div class="card-body text-center">
          <p class="mb-2">
            <strong>{{ email|e }}</strong>
          </p>

          <p class="mb-4">Pay <strong>{{ amount }}</strong> KES to subscribe.</p>

          <!-- Paystack Payment Button -->
          <button id="payButton" type="button" class="btn btn-lg" style="background:#b30059;color:#fff;padding:12px 28px;border-radius:8px;">
            Pay Now
          </button>

          <p class="mt-3 text-muted small">Transactions secured by Paystack</p>
        </div>

        <div class="card-footer text-center text-muted">
          Thank you for supporting BiteRight üéâ
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Paystack Inline JS -->
<!-- Paystack Inline JS -->
<script src="https://js.paystack.co/v1/inline.js"></script>

<div class="checkout-container">
  <h2>BiteRight Premium</h2>
  <p><strong>{{ email }}</strong></p>
  <p>KES {{ amount }}</p>

  <button id="payButton" class="btn btn-success">Pay Now</button>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const payButton = document.getElementById("payButton");

  payButton.addEventListener("click", function () {
    console.log("üöÄ Paystack payment starting...");

    // ‚úÖ Injected safely from Flask (always strings/numbers)
    const paystackKey = "{{ PAYSTACK_PUBLIC_KEY }}";
    const customerEmail = "{{ email|e }}";
    const amountKobo = Number("{{ amount|int }}") * 100;  // Ensure it's a number
    const customerName = "{{ session.get('username', 'BiteRight User') }}";

    const handler = PaystackPop.setup({
      key: paystackKey,
      email: customerEmail,
      amount: amountKobo,
      currency: "KES", // ‚ö†Ô∏è Ensure your Paystack account supports KES
      ref: "biteright-" + Date.now(),
      metadata: {
        custom_fields: [
          {
            display_name: "Customer Name",
            variable_name: "customer_name",
            value: customerName
          }
        ]
      },
      callback: function (response) {
        console.log("‚úÖ Paystack callback:", response);

        // Send reference to backend for verification
        fetch("/verify-payment", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ reference: response.reference })
        })
        .then(r => r.json())
        .then(res => {
          console.log("verify-payment response:", res);
          if (res.status === "success") {
            alert("‚úÖ Payment successful! Thank you.");
            window.location.href = "/";
          } else {
            alert("‚ö†Ô∏è Payment verification failed. See console for details.");
            console.log("verify failed:", res);
          }
        })
        .catch(err => {
          console.error("verify-payment error:", err);
          alert("‚ö†Ô∏è Error verifying payment.");
        });
      },
      onClose: function () {
        console.log("‚ùå Payment popup closed");
      }
    });

    handler.openIframe();
  });
});
</script>

{% endblock %}

